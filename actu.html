

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datos</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="/Styles/actu.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body>

    <header class="barra-superior">
        <h2>Administración</h2>
    </header>
    <br><br>
    <br><br>
    
    <div class="kok">
        <h3>Coordinador </h3>
    </div>

    <form id="updateForm">
        <input type="hidden" id="action" name="action">
        <input type="hidden" id="recordId" name="recordId">
        <div class="container text-center">
            <div class="row align-items-start">
                <div class="col">
                    <div class="form-group">
                        <label for="id">ID:</label>
                        <input type="text" id="id" name="id" readonly class="form-control">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="nombre">Nombre:</label>
                        <input type="text" id="nombre" name="nombre" class="form-control" required>
                        <div class="invalid-feedback">Por favor ingresa el nombre.</div>
                    </div>
                </div>
                <div class="col"></div>
                <div class="col"></div>
            </div>
        </div>

    </form>
    <br>




    <div id="metas-container">

        <h3>Metas</h3>
        <br>
        <button type="button" class="metg" data-bs-toggle="modal" data-bs-target="#exampleModal">
            <img class="metga" src="Imagenes/agregar.png">
            Agregar
        </button>
        <br><br>
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th style="display:none;">Id Coordinador</th>
                    <th>Meta</th>
                    <th>Piso 1</th>
                    <th>Piso 2</th>
                    <th>Piso 3</th>
                    <th>Fecha</th>
                    <th>Opcion</th>
                </tr>
            </thead>
            <tbody id="metas-body">

            </tbody>
        </table>


    </div>
    <br>
    <div id="penalidades-container">
        <h3>Penalidades</h3>
        <br>
        <button type="button" class="metg" data-bs-toggle="modal" data-bs-target="#exampleModa">
            <img class="metga" src="Imagenes/agregar.png">
            Agregar
        </button>
        <br><br>
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Porcentaje</th>
                    <th>Opcion</th>
                </tr>
            </thead>
            <tbody id="penalidades-body">

            </tbody>
        </table>
    </div>
    <br>
    <div class="cento">
        <button onclick="cancel()" class="boton1">Cancelar</button>
        <button onclick="deleteRecord()" class="boton3">Eliminar</button>
        <button class="boton4" id="downloadButton">Descargar</button>
        <button class="boton2" id="updateButton">Actualizar</button>


    </div>
    <div id="deleteModal" class="modal" style="display: none;">
        <div class="modal-content">
            <br><br>
            <p>¿Estás seguro de que quieres eliminar este registro?</p>

            <div class="button-container">
                <br>
                <button id="confirmDelete" class="button">Aceptar</button>
                <button id="cancelDelete" class="button">Cancelar</button>
            </div>
        </div>
    </div>
    <div>

    </div>
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <p>¿Estás seguro de que quieres eliminar esta penalidad?</p>
            <button id="confirmDelete">Confirmar</button>
            <button id="cancelDelete">Cancelar</button>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Agregar Meta</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="col">
                        <form id="insertForm">
                            <div class="form-group">
                                <label for="coordinador_ID">Id Coordinador:</label>
                                <input type="number" id="coordinador_ID" name="coordinador_ID" class="form-control"
                                    required>
                            </div>
                            <div class="form-group">
                                <label for="Metas">Meta:</label>
                                <input type="text" id="Metas" name="Metas" class="form-contr" required>
                            </div>
                            <div class="form-group">
                                <label for="Piso_1">Piso_1:</label>
                                <input type="text" id="Piso_1" name="Piso_1" class="form-control" required>
                            </div>
                            <br>
                            <div class="form-group">
                                <label for="Piso_2">Piso_2:</label>
                                <input type="text" id="Piso_2" name="Piso_2" class="form-control" required>
                            </div>
                            <br>
                            <div class="form-group">
                                <label for="Piso_3">Piso_3:</label>
                                <input type="text" id="Piso_3" name="Piso_3" class="form-control" required>
                            </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" onclick="insertData()" class="btn btn-primary">Ingresar</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="exampleModa" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Agregar Penalidades</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="col">
                        <form id="insertForm">
                            <div class="form-group">
                                <label for="Coordinador_ID">Id Coordinador:</label>
                                <input type="text" id="coordinador" name="coordinador" class="form-control"
                                    required>
                            </div>
                            <div class="form-group">
                                <label for="Nombre">Nombre</label>
                                <input type="text" id="Nombre" name="Nombre" class="form-contr" required>
                            </div>

                            <div class="form-group">
                                <label for="Descripción">Descripción</label>
                                <input type="text" id="descripcion" name="descripcion" class="form-contro" required>
                            </div>

                            <div class="form-group">
                                <label for="Porcentaje_Penalización">Procentaje</label>
                                <input type="text" id="penalizacion" name="penalizacion"
                                    class="form-control" required>
                            </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button"  onclick="insertarDatos()" class="btn btn-primary">Ingresar</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            displayDataFromQueryParams();
            fetchMetasAndPenalidades();

            const updateButton = document.getElementById('updateButton');
            updateButton.addEventListener('click', function () {
                redirectToUpdatePage();
            });
            const downloadButton = document.getElementById('downloadButton');


            downloadButton.addEventListener('click', function () {

                downloadCoordinatorInfo();
            });
        });

        function redirectToUpdatePage() {

            const coordinatorId = document.getElementById('id').value;

            window.location.href = `update.html?id=${coordinatorId}`;
        }

        function downloadCoordinatorInfo() {

            const coordinatorId = document.getElementById('id').value;
            const coordinatorName = document.getElementById('nombre').value;

            const metasBody = document.getElementById('metas-body');
            const penalidadesBody = document.getElementById('penalidades-body');

            const metasArray = [];
            const penalidadesArray = [];


            for (const row of metasBody.rows) {
                const meta = {

                    meta: row.cells[1].textContent,
                    piso1: row.cells[2].textContent,
                    piso2: row.cells[3].textContent,
                    piso3: row.cells[4].textContent,
                    fecha: row.cells[5].textContent
                };
                metasArray.push(meta);
            }

            for (const row of penalidadesBody.rows) {
                const penalidad = {

                    nombre: row.cells[1].textContent,
                    descripcion: row.cells[2].textContent,
                    porcentaje: row.cells[3].textContent
                };
                penalidadesArray.push(penalidad);
            }

            const coordinatorData = {
                id: coordinatorId,
                nombre: coordinatorName,
                metas: metasArray,
                penalidades: penalidadesArray
            };


            const jsonContent = JSON.stringify(coordinatorData, null, 2);

            const blob = new Blob([jsonContent], { type: 'application/json' });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `coordinador_${coordinatorId}.json`;

            link.click();

            URL.revokeObjectURL(link.href);
        }

        function displayDataFromQueryParams() {
            const queryParams = new URLSearchParams(window.location.search);
            for (const [key, value] of queryParams) {
                const element = document.getElementById(key);
                if (element) {
                    element.value = value;
                }
            }
        }
        function cancel() {
            window.history.back();
        }

        function deleteMeta(metaId) {
            const modal = document.getElementById('deleteModal');
            const confirmDelete = document.getElementById('confirmDelete');
            const cancelDelete = document.getElementById('cancelDelete');
            const closeBtn = modal.querySelector('.close');

            modal.style.display = 'block';

            function closeModal() {
                modal.style.display = 'none';
            }

            confirmDelete.onclick = function () {
                fetch(`http://localhost:8000/eliminar/meta/${metaId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error al eliminar la meta');
                        }

                        fetchMetasAndPenalidades(); // Esta función debería ser adaptada para cargar solo las metas, no las penalidades.
                        Swal.fire({
                            icon: 'success',
                            title: 'Meta eliminada correctamente',
                            text: '',
                            confirmButtonText: 'Aceptar',
                        })
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: error.message,
                            confirmButtonText: 'Aceptar',
                        })
                    });

                closeModal();
            };

            cancelDelete.onclick = function () {
                closeModal();
            };


            window.onclick = function (event) {
                if (event.target === modal) {
                    closeModal();
                }
            };
        }

        function deleteRecord() {

            const id = document.getElementById('id').value;

            const modal = document.getElementById('deleteModal');
            const confirmDelete = document.getElementById('confirmDelete');
            const cancelDelete = document.getElementById('cancelDelete');
            const closeBtn = modal.querySelector('.close');

            modal.style.display = 'block';

            function closeModal() {
                modal.style.display = 'none';
            }


            confirmDelete.onclick = function () {
                fetch(`http://localhost:8000/eliminar/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error al eliminar los datos');
                        }


                        Swal.fire({
                            icon: 'success',
                            title: 'Registro eliminado correctamente',
                            text: '',
                            confirmButtonText: 'Aceptar',
                        }).then(() => {
                            // Redirigir a la página add.html
                            window.location.href = 'add.html';
                        })
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: error.message,
                            confirmButtonText: 'Aceptar',
                        })
                    });

                closeModal();
            };


            cancelDelete.onclick = function () {
                closeModal();
            };

            closeBtn.onclick = closeModal;

            window.onclick = function (event) {
                if (event.target === modal) {
                    closeModal();
                }
            };
        }

        function insertarDatos() {
            // Obtener los valores del formulario
            var nombre = document.getElementById("Nombre").value;
            var descripcion = document.getElementById("descripcion").value;
            var penalizacion = document.getElementById("penalizacion").value;
            var coordinador = document.getElementById("coordinador").value;

            // Crear un objeto con los datos del formulario
            var data = {
                nombre: nombre,
                descripcion: descripcion,
                penalizacion: penalizacion,
                coordinador: coordinador
            };

            // Enviar los datos al servidor utilizando Fetch
            fetch('http://localhost:3000/insertar_datos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Respuesta del servidor:', data);
                if (data.success) {
                    alert('Datos insertados correctamente.');
                    // Puedes hacer más aquí, como redireccionar a otra página.
                } else {
                    alert('Error al insertar datos.');
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

        function insertData() {
            const coordinador_ID = document.getElementById('coordinador_ID').value;
            const Metas = document.getElementById('Metas').value;
            const Piso_1 = document.getElementById('Piso_1').value;
            const Piso_2 = document.getElementById('Piso_2').value;
            const Piso_3 = document.getElementById('Piso_3').value;

            const dataMetas = {
                coordinador_ID: coordinador_ID,
                Metas: Metas,
                Piso_1: Piso_1,
                Piso_2: Piso_2,
                Piso_3: Piso_3
            };

            fetch('http://localhost:8000/metas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataMetas)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al insertar datos de metas');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Datos de metas insertados correctamente');
                    Swal.fire({
                        icon: 'success',
                        title: 'Éxito',
                        text: 'Datos insertados correctamente',
                    }).then((result) => {
                       
                    });
                })
                .catch(error => {
                    console.error('Error al insertar datos de metas:', error.message);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Hubo un error al insertar los datos de metas',
                    });
                });
        }

        function fetchMetasAndPenalidades() {
            const id = document.getElementById('id').value;


            fetch(`http://localhost:3000/metas_penalidades?id=${id}`)
                .then(response => response.json())
                .then(data => {
                    displayMetas(data.metas);
                    displayPenalidades(data.penalidades);
                })
                .catch(error => {
                    console.error('Error fetching metas and penalidades:', error);
                });

            function displayMetas(metas) {
                const metasBody = document.getElementById('metas-body');

                metas.sort((a, b) => new Date(a.Fecha) - new Date(b.Fecha));

                metas.forEach(meta => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${meta.id}</td>
                    <td style="display:none;">${meta.coordinador_ID}
                    <td>${meta.Metas}</td>
                    <td>${meta.Piso_1}</td>
                    <td>${meta.Piso_2}</td>
                    <td>${meta.Piso_3}</td>
                    <td>${formatDate(meta.Fecha)}</td>
                    <td>

                            <div class="row align-items-start">
                                
                                <div class="col">
                                <button class="butac" onclick="redirectToMetaPage(${meta.id})">Actualizar</button>
                                </div>
                                <div class="col">
                                <button class="butap" onclick="deleteMeta(${meta.id})" data-id="${meta.id}">Eliminar</button>
                                </div>
                            </div>
                        
                    </td>
                `;
                    metasBody.appendChild(row);
                });
            }
        }
        function redirectToMetaPage(metaId) {

            window.location.href = `meta.html?id=${metaId}`;
        }




        function formatDate(dateString) {
            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            return new Date(dateString).toLocaleDateString('es-ES', options);
        }

        function displayPenalidades(penalidades) {
    const penalidadesBody = document.getElementById('penalidades-body');
    penalidades.forEach(penalidad => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${penalidad.ID}</td>
            <td>${penalidad.Nombre}</td>
            <td>${penalidad.Descripción}</td>
            <td>${penalidad.Porcentaje_Penalización}</td>
            <td class="metg">
                <div class="container text-center">
                    <div class="row align-items-start">
                        <div class="col-3">
                            <button class="butal">Actualizar</button>
                        </div>
                        <div class="col-4">
                            <button class="butao" onclick="openDeleteModal(${penalidad.ID})">Eliminar</button>
                        </div>
                    </div>
                </div>
            </td>`;
        penalidadesBody.appendChild(row);
    });
    // Asigna eventos después de agregar todas las filas
    assignEvents();
}

function openDeleteModal(id) {
    const modal = document.getElementById('deleteModal');
    modal.style.display = 'block';
    document.getElementById('confirmDelete').onclick = function () {
        deletePena(id);
        modal.style.display = 'none';
    };
    document.getElementById('cancelDelete').onclick = function () {
        modal.style.display = 'none';
    };
    window.onclick = function (event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    };
}

function deletePena(id) {
    fetch(`http://localhost:8080/penalidades/${id}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Error al eliminar la penalidad');
        }
        // Actualiza UI aquí
        Swal.fire({
            icon: 'success',
            title: 'Penalidad eliminada correctamente',
            text: '',
            confirmButtonText: 'Aceptar',
        });
    })
    .catch(error => {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.message,
            confirmButtonText: 'Aceptar',
        });
    });
}

function assignEvents() {
    // Asigna eventos a los botones después de agregar todas las filas
    const deleteButtons = document.querySelectorAll('.butao');
    deleteButtons.forEach(button => {
        button.onclick = function() {
            const id = button.dataset.id; // Asegúrate de asignar el ID correctamente
            openDeleteModal(id);
        };
    });
}


        // Assuming you have some way to fetch and populate penalidades
       
        displayPenalidades(penalidades);


        document.addEventListener("DOMContentLoaded", function () {

            function displayMetas(metas) {
                const metasBody = document.getElementById('metas-body');

                metas.sort((a, b) => new Date(a.Fecha) - new Date(b.Fecha));

                metas.forEach(meta => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td style="display:none;">${meta.id}</td>
                    <td>${meta.Metas}</td>
                    <td>${meta.Piso_1}</td>
                    <td>${meta.Piso_2}</td>
                    <td>${meta.Piso_3}</td>
                    <td>${formatDate(meta.Fecha)}</td>
                    <td class="metce"><button onclick="redirectToMetaPage(${meta.id})">Actualizar</button></td>
                `;
                    metasBody.appendChild(row);
                });
            }

            function redirectToMetaPage(metaId) {

                window.location.href = `meta.html?id=${metaId}`;
            }

        });

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

</html>